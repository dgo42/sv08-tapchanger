[tools_calibrate]
# Nudge config
#
# These two values should be changed or checked.
#
# 'pin' should reference the pin used for Nudge.
pin: ^PD8
# 'spread' is the amount of X or Y motion used in the probing sequence.
# Think of it as the clearance from the center, to accomodate the pin's diameter and any
# initial starting-point inaccuracy.
# For larger pins (5mm), increase this to 3.5mm+.
#   Increase this and/or improve the accuracy of the starting point if the probe triggers too early.
#   Decrease this and/or improve the accuracy of the starting point if the motion
#     pushes your printer beyond the allowed travel amount.
spread: 2.3
#
# Config below is unlikely to need changes.
#
# 'lower_z' is the distance below the probe tip in Z, used to ensure a hit.
#   Increase this to have more of the nozzle hit during probing.
#   Values as low as 0.1mm may work, and will minimize the need for overtravel.
lower_z: 0.2
travel_speed: 100
speed: 2.5
lift_speed: 4
final_lift_z: 4
sample_retract_dist: 2
samples_tolerance: 0.05
samples: 1
samples_result: median
trigger_to_bottom_z: 3
# If using a built-in Z probe to find the Nudge pin top, reference it here.
# This is only relevant for the flipped configuration, to provide resistance to pushing, for Tap/Boop/Poke/etc.
# Most should leave this commented out.
#probe: probe

[gcode_macro NUDGE_MOVE_OVER_PROBE]
gcode:
  #  Sensor location at 74.258390,355.160350,1.276094
  G90
  G0 Z4
  # Put your specific values here!
  # Update them too, after the first run.
  G0 X151.6 Y360.7 F9000

[gcode_macro NUDGE_FIND_TOOL_OFFSET]
gcode:
  BED_MESH_CLEAR
  NUDGE_MOVE_OVER_PROBE
  TOOL_LOCATE_SENSOR

[gcode_macro NUDGE_FIND_TOOL_OFFSETS]
gcode:
    {% set main_z_offset = printer.gcode_move.homing_origin.z %}
    RESPOND TYPE=echo MSG='{"T0 Z offset %0.6f" % main_z_offset}'
    T0
    M109 T0 S150  # Heat up as much as possible without oozing to account for any thermal deformations
    NUDGE_FIND_TOOL_OFFSET
    M104 T0 S0
    # Match your number of tools:
    #   [1, 2, 3] for a 4-head toolchanger.
    #   [1] for IDEX or Dual Gantry.
    {% for tool in [1] %}
        # Start heating next tool before change to reduce wait time
        M104 T{tool} S150
        T{tool}
        # Wait target temperatuew
        M109 T{tool} S150
        NUDGE_MOVE_OVER_PROBE
        TOOL_CALIBRATE_TOOL_OFFSET
        TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T{tool}" ATTRIBUTE=gcode_x_offset VALUE={'{x:0.6f}'}
        TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T{tool}" ATTRIBUTE=gcode_y_offset VALUE={'{y:0.6f}'}
        #TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T{tool}" ATTRIBUTE=gcode_z_offset VALUE={'{z:0.6f}'} Z_OFFSET={main_z_offset}
        TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T{tool}" ATTRIBUTE=gcode_z_offset VALUE={'{z:0.6f}'}
        M104 T{tool} S0
    {% endfor %}
    #TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T0" ATTRIBUTE=gcode_z_offset VALUE={main_z_offset}

#[gcode_macro PRINT_OFFSET]
#gcode:
#  RESPOND TYPE=echo MSG='{"T0 Z offset %0.6f" % printer.gcode_move.homing_origin.z}'
#  {% set tool_z_offset_float = printer.tools_calibrate.last_result.2|float %}
#  RESPOND TYPE=echo MSG='{"T1 -> T0 Z offset %0.6f" % tool_z_offset_float}'
#  {% set tool_z_offset = "%0.6f" % (printer.gcode_move.homing_origin.z + tool_z_offset_float) %}
#  #{% set test = -0.1755356  %}
#  #{% set tool_z_offset = "%0.6f" % (printer.gcode_move.homing_origin.z + test) %}
#  RESPOND TYPE=echo MSG='{"Resultimg T1 Z offset %s" % tool_z_offset}'

#[gcode_macro CALIB_TEST]
#gcode:
#  TOOL_CALIBRATE_SAVE_TOOL_OFFSET SECTION="tool T{tool}" ATTRIBUTE=gcode_z_offset VALUE={'{(z + -0.164):0.6f}'}
